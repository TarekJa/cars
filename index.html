<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#1f3b35" />
  <meta name="description" content="Ù…ØªØ§Ø¨Ø¹Ø© ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ§Ù„Ø³ÙŠÙƒÙˆØ±ØªØ§ Ù„ÙƒÙ„ Ø³ÙŠØ§Ø±Ø©" />

  <!-- Icons in root -->
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">

  <title>Al Ajamy Food â€“ Cars Tracker</title>

  <style>
    :root{
      /* Brand-ish palette (green/teal like logo) */
      --bg: #151a1c;
      --bg2:#111416;
      --card:#1b2224;
      --card2:#171d1f;
      --line:#3b4448;        /* darker gray */
      --line2:#4a555a;       /* slightly brighter for separation */
      --txt:#eaf2f1;
      --muted:#b6c3c1;
      --teal:#4f9d8b;
      --teal2:#2f6f61;
      --gold:#f0b354;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 20px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Arabic", "Noto Naskh Arabic", sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--txt);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(79,157,139,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(240,179,84,.16), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 14px 14px;
      background: linear-gradient(90deg, rgba(79,157,139,.20), rgba(240,179,84,.12));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 24px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 50;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex:1;
    }
    .logo{
      width: 44px; height: 44px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.15);
      flex: 0 0 auto;
      display:flex; align-items:center; justify-content:center;
    }
    .logo img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      font-weight: 800;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex:0 0 auto;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      transition: .15s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); }
    .btn.primary{
      background: rgba(79,157,139,.18);
      border-color: rgba(79,157,139,.38);
    }
    .btn.danger{
      background: rgba(255,60,60,.12);
      border-color: rgba(255,60,60,.30);
    }

    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.15);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* Grid */
    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns: 1fr; }
      .topbar{ position: static; }
    }

    /* Card */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08));
      border: 2px solid var(--line2); /* clearer separation */
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{
      padding: 14px 14px 12px;
      background: radial-gradient(700px 260px at 30% -20%, rgba(79,157,139,.12), transparent 60%);
    }

    .card-head{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    /* Plate (Turkey style) */
    .plate{
      display:flex;
      align-items: stretch;
      border: 2px solid rgba(0,0,0,.35);
      border-radius: 12px;
      overflow:hidden;
      background: #f4f6f7;
      color: #111;
      min-width: 210px;
      max-width: 100%;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .plate .band{
      background: #0b3c92;
      color: #fff;
      padding: 8px 10px;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap: 2px;
      min-width: 52px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.8px;
    }
    .plate .band .tr{ font-size: 13px; line-height: 1; }
    .plate .band .stars{ font-size: 11px; opacity:.95; line-height: 1; }
    .plate .num{
      padding: 10px 14px;
      font-family: var(--mono);
      font-weight: 900;
      font-size: 18px;
      letter-spacing: 1px;
      display:flex;
      align-items:center;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    /* Status badge */
    .badge{
      border-radius: 999px;
      border: 1px solid rgba(240,179,84,.35);
      background: rgba(0,0,0,.22);
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 900;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      color: var(--txt);
      max-width: 100%;
    }
    .badge small{
      font-weight: 800;
      color: var(--muted);
      font-size: 12px;
    }

    .badge .dot{
      width:10px; height:10px; border-radius: 50%;
      background: var(--teal);
      box-shadow: 0 0 0 3px rgba(79,157,139,.12);
      flex: 0 0 auto;
    }
    .badge.urgent{ border-color: rgba(255,70,70,.42); }
    .badge.urgent .dot{ background:#ff3b3b; box-shadow: 0 0 0 3px rgba(255,70,70,.14); }
    .badge.alert{ border-color: rgba(255,210,70,.42); }
    .badge.alert .dot{ background:#ffd84a; box-shadow: 0 0 0 3px rgba(255,210,70,.14); }
    .badge.follow{ border-color: rgba(255,140,40,.42); }
    .badge.follow .dot{ background:#ff8a24; box-shadow: 0 0 0 3px rgba(255,140,40,.14); }
    .badge.safe{ border-color: rgba(70,220,130,.38); }
    .badge.safe .dot{ background:#32d27b; box-shadow: 0 0 0 3px rgba(70,220,130,.14); }
    .badge.long{ border-color: rgba(120,220,160,.28); }
    .badge.long .dot{ background:#34c28a; box-shadow: 0 0 0 3px rgba(120,220,160,.12); }
    .badge.expired{ border-color: rgba(255,70,70,.46); }
    .badge.expired .dot{ background:#ff3b3b; box-shadow: 0 0 0 3px rgba(255,70,70,.14); }

    /* Info block */
    .info{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      border-radius: var(--radius2);
      padding: 10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }
    .row b{
      color: var(--txt);
      font-weight: 900;
      margin-inline-start: 8px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Two blocks (Inspection / Sigorta) */
    .blocks{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .blocks{ grid-template-columns: 1fr; }
      .plate{ min-width: 0; width: 100%; }
    }

    .block{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      border-radius: var(--radius2);
      padding: 10px;
      position: relative;
      overflow:hidden;
    }
    .block h3{
      margin: 0 0 6px;
      font-size: 16px;      /* larger label */
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .remain{
      display:flex;
      align-items: baseline;
      gap: 8px;             /* ensures space between number and text */
      justify-content:flex-end;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .remain .num{
      font-size: 26px;      /* slightly smaller than before */
      font-weight: 1000;
      line-height: 1;
      letter-spacing: .4px;
    }
    .remain .txt{
      font-size: 16px;      /* bigger text */
      font-weight: 900;
      color: var(--muted);
      white-space: nowrap;
    }
    .dateLine{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 800;
      margin-bottom: 8px;
    }
    .dateLine b{ color: var(--txt); font-weight: 1000; }

    /* Progress bar */
    .bar{
      height: 12px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      position: relative;
    }
    .bar > span{
      display:block;
      height:100%;
      width: 20%;
      background: linear-gradient(90deg, var(--teal2), var(--teal));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .bar.urgent > span{ background: linear-gradient(90deg, #ff3b3b, #ff6b6b); }
    .bar.alert  > span{ background: linear-gradient(90deg, #ffd84a, #ffec8a); }
    .bar.follow > span{ background: linear-gradient(90deg, #ff8a24, #ffb15c); }
    .bar.safe   > span{ background: linear-gradient(90deg, #25c46a, #40e08b); }
    .bar.long   > span{ background: linear-gradient(90deg, #25c46a, #40e08b); }
    .bar.expired> span{ background: linear-gradient(90deg, #ff3b3b, #ff6b6b); }

    /* Footer controls in edit mode */
    .card-actions{
      display:flex;
      gap:10px;
      margin-top: 10px;
      justify-content:flex-start;
    }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 1000;
    }
    .modal.show{ display:flex; }
    .modal-box{
      width: min(740px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(0,0,0,.18);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modal-head h2{
      margin:0;
      font-size: 16px;
      font-weight: 1000;
    }
    .modal-body{
      padding: 14px;
    }
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 640px){
      .form{ grid-template-columns: 1fr; }
    }
    label{
      display:flex;
      flex-direction: column;
      gap:6px;
      font-size: 13px;
      font-weight: 900;
      color: var(--muted);
    }
    input, select{
      height: 40px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline:none;
      font-weight: 800;
      font-size: 14px;
    }
    input::placeholder{ color: rgba(234,242,241,.45); }

    .modal-foot{
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      justify-content:flex-start;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(234,242,241,.55);
      line-height: 1.6;
    }

    .toast{
      position: fixed;
      left: 14px;
      bottom: 14px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      font-weight: 900;
      display:none;
      z-index: 1500;
    }
    .toast.show{ display:block; }

  </style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo" title="Logo">
        <img src="/logo.png" alt="Al Ajamy Food Logo" onerror="this.style.display='none'">
      </div>
      <div style="min-width:0">
        <h1>Al Ajamy Food â€“ Cars Tracker</h1>
        <div class="sub" id="lastSync">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: â€”</div>
      </div>
    </div>

    <div class="actions">
      <span class="pill" id="countPill">â€” Ø³ÙŠØ§Ø±Ø©</span>
      <button class="btn" id="btnRefresh" type="button">ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn primary" id="btnEdit" type="button">ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </div>
  </div>

  <div class="grid" id="grid"></div>
</div>

<!-- Modal for password / edit -->
<div class="modal" id="pwModal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-head">
      <h2>ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</h2>
      <button class="btn" type="button" onclick="closePw()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="modal-body">
      <label>
        ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        <input id="pwInput" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password">
      </label>
      <div class="hint">
        Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØªÙ… ØªÙØ¹ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù.<br>
        Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø³ØªÙØ­ÙØ¸ Ø¹Ù„Ù‰ Google Sheet ÙˆØªØ¸Ù‡Ø± Ù„Ù„ÙƒÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« (ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ 20 Ø«Ø§Ù†ÙŠØ©).
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn primary" type="button" onclick="confirmPw()">ØªØ£ÙƒÙŠØ¯</button>
    </div>
  </div>
</div>

<!-- Modal for add/edit car -->
<div class="modal" id="editModal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-head">
      <h2 id="editTitle">ØªØ¹Ø¯ÙŠÙ„ Ø³ÙŠØ§Ø±Ø©</h2>
      <button class="btn" type="button" onclick="closeEdit()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="modal-body">
      <div class="form">
        <label>id
          <input id="f_id" type="text" placeholder="Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ÙŠ" disabled>
        </label>
        <label>plate (Ù…Ø«Ù„: 34 TP 0348)
          <input id="f_plate" type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
        </label>
        <label>vehicle
          <input id="f_vehicle" type="text" placeholder="Ù†ÙˆØ¹/Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
        </label>
        <label>driver
          <input id="f_driver" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚">
        </label>
        <label>driver_phone
          <input id="f_driver_phone" type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        </label>
        <label>branch
          <input id="f_branch" type="text" placeholder="Ø§Ù„ØªØ¨Ø¹ÙŠØ©/Ø§Ù„ÙØ±Ø¹">
        </label>
        <label>inspection_date (DD-MM-YYYY)
          <input id="f_inspection" type="text" placeholder="Ù…Ø«Ø§Ù„: 02-04-2026">
        </label>
        <label>sigorta_date (DD-MM-YYYY)
          <input id="f_sigorta" type="text" placeholder="Ù…Ø«Ø§Ù„: 13-11-2026">
        </label>
      </div>
      <div class="hint">
        ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙŠ Ø§Ù„Ø´ÙŠØª: <b>DD-MM-YYYY</b> (Ù…Ø«Ù„: 02-04-2026).<br>
        ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙØ§Ø±ØºÙ‹Ø§ Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn primary" type="button" onclick="saveEdit()">Ø­ÙØ¸</button>
      <button class="btn danger" id="btnDeleteInModal" type="button" onclick="deleteFromModal()" style="display:none">Ø­Ø°Ù</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =======================
   SETTINGS
======================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyQxBuejrMv-YuaY46xF08MWOmo14jwuVG8ytr3-zABxSw528NgyHvDKFICPXRvpeW8EQ/exec";
const POLL_MS = 20000;

/* =======================
   STATE
======================= */
let DATA = [];
let EDIT_MODE = false;
let EDIT_PASS = "";
let EDITING_ID = null;
let modalOpen = false;
let lastScrollY = 0;

/* =======================
   HELPERS
======================= */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 2200);
}

function pad2(n){ return String(n).padStart(2,"0"); }

function parseAnyDate(s){
  if(!s) return null;
  const str = String(s).trim();
  if(!str) return null;

  // YYYY-MM-DD or YYYY/MM/DD
  if (/^\d{4}[-/]\d{1,2}[-/]\d{1,2}$/.test(str)){
    const [y,m,d] = str.split(/[-/]/).map(Number);
    return new Date(y, m-1, d);
  }
  // DD/MM/YYYY
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(str)){
    const [d,m,y] = str.split("/").map(Number);
    return new Date(y, m-1, d);
  }
  // DD-MM-YYYY (your sheet)
  if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(str)){
    const [d,m,y] = str.split("-").map(Number);
    return new Date(y, m-1, d);
  }
  return null;
}

function formatDDMMYYYY(dateObj){
  if(!dateObj) return "";
  const d = pad2(dateObj.getDate());
  const m = pad2(dateObj.getMonth()+1);
  const y = dateObj.getFullYear();
  return `${d}-${m}-${y}`;
}

function daysRemaining(dateStr){
  const dt = parseAnyDate(dateStr);
  if(!dt) return null;
  const today = new Date();
  today.setHours(0,0,0,0);
  dt.setHours(0,0,0,0);
  const diff = Math.round((dt - today) / 86400000);
  return diff;
}

function statusForDays(d){
  if(d === null) return { cls:"long", label:"â€”", icon:"", dot:true };
  if(d < 0)   return { cls:"expired", label:"Ù…Ù†ØªÙ‡ÙŠØ©", icon:"â›”", dot:true };
  if(d <= 15) return { cls:"urgent",  label:"Ø¹Ø§Ø¬Ù„",   icon:"ğŸ”´", dot:true };
  if(d <= 30) return { cls:"alert",   label:"ØªÙ†Ø¨ÙŠÙ‡",  icon:"âš ï¸", dot:true }; // triangle with !
  if(d <= 60) return { cls:"follow",  label:"Ù…ØªØ§Ø¨Ø¹Ø©", icon:"ğŸŸ ", dot:true };
  if(d <=120) return { cls:"safe",    label:"Ø§Ù„Ù…Ø¯Ø© Ø¢Ù…Ù†Ø©", icon:"ğŸŸ¢", dot:true };
  return         { cls:"long",    label:"Ù…Ø¯Ø© Ø·ÙˆÙŠÙ„Ø©", icon:"ğŸŸ©", dot:true };
}

function barWidth(d){
  if(d === null) return 0;
  if(d < 0) return 100;
  // scale: 0..120 => 100..10 (closer = more filled)
  const capped = Math.min(Math.max(d, 0), 120);
  const w = 100 - Math.round((capped/120)*85); // 100..15
  return Math.max(10, Math.min(100, w));
}

/* =======================
   GOOGLE SHEET SYNC
======================= */
function jsonpLoad(){
  return new Promise((resolve, reject)=>{
    const cbName = "cbCars_" + Date.now();
    window[cbName] = (res)=>{
      try { resolve(res); }
      finally { delete window[cbName]; script.remove(); }
    };
    const script = document.createElement("script");
    script.src = API_URL + "?callback=" + cbName + "&ts=" + Date.now();
    script.onerror = ()=>{ delete window[cbName]; script.remove(); reject(new Error("JSONP load failed")); };
    document.body.appendChild(script);
  });
}

async function syncFromSheet(){
  try{
    const res = await jsonpLoad();
    if(res && res.ok){
      const incoming = (res.data || []).map(x => ({
        id: String(x.id ?? "").trim(),
        plate: String(x.plate ?? ""),
        vehicle: String(x.vehicle ?? ""),
        driver: String(x.driver ?? ""),
        driver_phone: String(x.driver_phone ?? ""),
        branch: String(x.branch ?? ""),
        inspection_date: String(x.inspection_date ?? ""),
        sigorta_date: String(x.sigorta_date ?? "")
      })).filter(x => x.id);

      // Donâ€™t re-render if edit modal open (avoid jump while typing)
      DATA = incoming;
      document.getElementById("lastSync").textContent =
        "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + new Date().toLocaleString("en-GB");
      document.getElementById("countPill").textContent = DATA.length + " Ø³ÙŠØ§Ø±Ø©";

      if(!modalOpen) render();
    }
  }catch(e){
    // silent to avoid spamming
  }
}

function postNoCors(payload){
  return fetch(API_URL, {
    method: "POST",
    mode: "no-cors",
    headers: {"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify(payload)
  });
}

/* =======================
   RENDER
======================= */
function render(){
  const grid = document.getElementById("grid");
  lastScrollY = window.scrollY;

  // sort by nearest due (min of both positive days, expired first)
  const items = [...DATA].sort((a,b)=>{
    const da1 = daysRemaining(a.inspection_date);
    const da2 = daysRemaining(a.sigorta_date);
    const db1 = daysRemaining(b.inspection_date);
    const db2 = daysRemaining(b.sigorta_date);

    const minA = minDue(da1, da2);
    const minB = minDue(db1, db2);
    return minA - minB;
  });

  grid.innerHTML = items.map(cardHtml).join("");

  // restore scroll after render
  requestAnimationFrame(()=> window.scrollTo({ top: lastScrollY }));
}

function minDue(d1, d2){
  const arr = [d1, d2].filter(v => v !== null);
  if(arr.length === 0) return 999999;
  // expired should come first
  const hasExpired = arr.some(v => v < 0);
  if(hasExpired) return -999999;
  return Math.min(...arr);
}

function cardHtml(car){
  const di = daysRemaining(car.inspection_date);
  const ds = daysRemaining(car.sigorta_date);

  const si = statusForDays(di);
  const ss = statusForDays(ds);

  // overall status: based on nearest
  let overall = si;
  if(ds !== null){
    if(di === null) overall = ss;
    else{
      const min = minDue(di, ds);
      overall = (min === di) ? si : ss;
    }
  }

  const overallText = (overall.label === "â€”")
    ? "â€”"
    : `${overall.icon} ${overall.label} â€¢ ${Math.max((minDue(di,ds) < 0 ? 0 : minDue(di,ds)), 0)} ÙŠÙˆÙ…`;

  const deleteBtn = EDIT_MODE
    ? `<button class="btn danger" type="button" onclick="askDelete('${escapeHtml(car.id)}')">Ø­Ø°Ù</button>`
    : "";

  const editBtn = EDIT_MODE
    ? `<button class="btn primary" type="button" onclick="openEdit('${escapeHtml(car.id)}')">ØªØ¹Ø¯ÙŠÙ„</button>`
    : "";

  const plateTxt = escapeHtml(String(car.plate || "").trim() || "â€”");

  return `
  <div class="card" id="car-${escapeHtml(car.id)}">
    <div class="card-inner">
      <div class="card-head">
        <div class="badge ${overall.cls}">
          <span class="dot"></span>
          <span>${escapeHtml(overallText)}</span>
        </div>

        <div class="plate" title="Ù„ÙˆØ­Ø© ØªØ±ÙƒÙŠØ§">
          <div class="band">
            <div class="stars">â˜… â˜… â˜…</div>
            <div class="tr">TR</div>
          </div>
          <div class="num">${plateTxt}</div>
        </div>
      </div>

      <div class="info">
        <div class="row"><span>Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù†ÙˆØ¹</span><b>${escapeHtml(car.vehicle || "â€”")}</b></div>
        <div class="row"><span>Ø§Ù„Ø³Ø§Ø¦Ù‚</span><b>${escapeHtml(car.driver || "â€”")}</b></div>
        <div class="row"><span>Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø§Ø¦Ù‚</span><b>${escapeHtml(car.driver_phone || "â€”")}</b></div>
        <div class="row"><span>Ø§Ù„ØªØ¨Ø¹ÙŠØ©</span><b>${escapeHtml(car.branch || "â€”")}</b></div>
      </div>

      <div class="blocks">
        ${blockHtml("Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©", car.inspection_date, di, si)}
        ${blockHtml("Ø§Ù„Ø³ÙŠÙƒÙˆØ±ØªØ§", car.sigorta_date, ds, ss)}
      </div>

      ${EDIT_MODE ? `<div class="card-actions">${editBtn}${deleteBtn}</div>` : ``}
    </div>
  </div>
  `;
}

function blockHtml(title, dateStr, days, st){
  const dShown = (days === null) ? "â€”" : (days < 0 ? 0 : days);
  const dateShown = escapeHtml(String(dateStr || "â€”"));
  const w = barWidth(days);
  return `
    <div class="block">
      <h3>${escapeHtml(title)}</h3>
      <div class="remain">
        <span class="num">${escapeHtml(String(dShown))}</span>
        <span class="txt">ÙŠÙˆÙ… Ù…ØªØ¨Ù‚ÙŠ</span>
      </div>
      <div class="dateLine"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</span><b>${dateShown}</b></div>
      <div class="bar ${st.cls}"><span style="width:${w}%"></span></div>
    </div>
  `;
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =======================
   EDIT MODE
======================= */
const pwModal = document.getElementById("pwModal");
const editModal = document.getElementById("editModal");
const btnEdit = document.getElementById("btnEdit");
const btnRefresh = document.getElementById("btnRefresh");

btnRefresh.addEventListener("click", ()=> { syncFromSheet(); toast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); });

btnEdit.addEventListener("click", ()=>{
  if(!EDIT_MODE){
    openPw();
  }else{
    // lock
    EDIT_MODE = false;
    EDIT_PASS = "";
    btnEdit.textContent = "ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
    toast("ØªÙ… Ù‚ÙÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
    render();
  }
});

function openPw(){
  pwModal.classList.add("show");
  pwModal.setAttribute("aria-hidden","false");
  document.getElementById("pwInput").value = "";
  document.getElementById("pwInput").focus();
}
function closePw(){
  pwModal.classList.remove("show");
  pwModal.setAttribute("aria-hidden","true");
}
function confirmPw(){
  const v = document.getElementById("pwInput").value.trim();
  if(!v){ toast("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); return; }
  EDIT_PASS = v;
  EDIT_MODE = true;
  btnEdit.textContent = "Ù‚ÙÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
  closePw();
  toast("ØªÙ… ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
  render();
}

/* =======================
   ADD / EDIT / DELETE
======================= */
function openEdit(id){
  const car = DATA.find(x => x.id === String(id));
  if(!car){ toast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©"); return; }
  modalOpen = true;
  EDITING_ID = String(id);

  document.getElementById("editTitle").textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø³ÙŠØ§Ø±Ø©";
  document.getElementById("btnDeleteInModal").style.display = "inline-flex";

  fillForm(car);
  editModal.classList.add("show");
  editModal.setAttribute("aria-hidden","false");
}

function openAdd(){
  modalOpen = true;
  EDITING_ID = null;

  document.getElementById("editTitle").textContent = "Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©";
  document.getElementById("btnDeleteInModal").style.display = "none";

  const nextId = String(getNextId());
  fillForm({
    id: nextId, plate:"", vehicle:"", driver:"", driver_phone:"", branch:"",
    inspection_date:"", sigorta_date:""
  });

  editModal.classList.add("show");
  editModal.setAttribute("aria-hidden","false");
}

function closeEdit(){
  editModal.classList.remove("show");
  editModal.setAttribute("aria-hidden","true");
  modalOpen = false;
  EDITING_ID = null;
}

function fillForm(car){
  document.getElementById("f_id").value = car.id || "";
  document.getElementById("f_plate").value = car.plate || "";
  document.getElementById("f_vehicle").value = car.vehicle || "";
  document.getElementById("f_driver").value = car.driver || "";
  document.getElementById("f_driver_phone").value = car.driver_phone || "";
  document.getElementById("f_branch").value = car.branch || "";
  document.getElementById("f_inspection").value = car.inspection_date || "";
  document.getElementById("f_sigorta").value = car.sigorta_date || "";
}

function normalizeDDMMYYYY(s){
  const str = String(s||"").trim();
  if(!str) return "";
  // accept dd-mm-yyyy only
  if(!/^\d{1,2}-\d{1,2}-\d{4}$/.test(str)) return null;
  const [d,m,y] = str.split("-").map(Number);
  if(d<1||d>31||m<1||m>12||y<1900||y>2100) return null;
  return `${pad2(d)}-${pad2(m)}-${y}`;
}

function saveEdit(){
  if(!EDIT_MODE || !EDIT_PASS){ toast("Ø§ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }

  const row = {
    id: String(document.getElementById("f_id").value || "").trim(),
    plate: String(document.getElementById("f_plate").value || "").trim(),
    vehicle: String(document.getElementById("f_vehicle").value || "").trim(),
    driver: String(document.getElementById("f_driver").value || "").trim(),
    driver_phone: String(document.getElementById("f_driver_phone").value || "").trim(),
    branch: String(document.getElementById("f_branch").value || "").trim(),
    inspection_date: String(document.getElementById("f_inspection").value || "").trim(),
    sigorta_date: String(document.getElementById("f_sigorta").value || "").trim()
  };

  if(!row.id){ toast("id Ù…Ø·Ù„ÙˆØ¨"); return; }

  // normalize dates
  if(row.inspection_date){
    const v = normalizeDDMMYYYY(row.inspection_date);
    if(!v){ toast("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± ØµØ­ÙŠØ­ (DD-MM-YYYY)"); return; }
    row.inspection_date = v;
  }
  if(row.sigorta_date){
    const v = normalizeDDMMYYYY(row.sigorta_date);
    if(!v){ toast("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³ÙŠÙƒÙˆØ±ØªØ§ ØºÙŠØ± ØµØ­ÙŠØ­ (DD-MM-YYYY)"); return; }
    row.sigorta_date = v;
  }

  postNoCors({ action:"upsert", pass: EDIT_PASS, row })
    .then(()=>{
      toast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
      closeEdit();
      setTimeout(syncFromSheet, 900);
    })
    .catch(()=> toast("ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸"));
}

function askDelete(id){
  if(!EDIT_MODE || !EDIT_PASS){ toast("Ø§ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }
  if(confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŸ")){
    postNoCors({ action:"delete", pass: EDIT_PASS, id })
      .then(()=>{ toast("ØªÙ… Ø§Ù„Ø­Ø°Ù"); setTimeout(syncFromSheet, 900); })
      .catch(()=> toast("ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù"));
  }
}

function deleteFromModal(){
  if(!EDITING_ID) return;
  askDelete(EDITING_ID);
  closeEdit();
}

function getNextId(){
  const ids = DATA.map(x => parseInt(x.id,10)).filter(n => Number.isFinite(n));
  const max = ids.length ? Math.max(...ids) : 0;
  return max + 1;
}

/* Add button (appears only in edit mode) */
(function injectAddBtn(){
  const actions = document.querySelector(".actions");
  const addBtn = document.createElement("button");
  addBtn.className = "btn primary";
  addBtn.type = "button";
  addBtn.id = "btnAdd";
  addBtn.textContent = "Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©";
  addBtn.style.display = "none";
  addBtn.addEventListener("click", ()=> openAdd());
  actions.insertBefore(addBtn, btnEdit);

  // toggle visibility when edit mode changes
  const obs = new MutationObserver(()=>{
    addBtn.style.display = EDIT_MODE ? "inline-flex" : "none";
  });
  obs.observe(btnEdit, { childList:true, subtree:true });
})();

/* =======================
   INIT
======================= */
syncFromSheet();
setInterval(syncFromSheet, POLL_MS);

</script>
</body>
</html>
