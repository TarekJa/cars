<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0f1d1a" />
  <meta name="description" content="Al Ajamy Food – Cars Tracker" />

  <!-- PWA / Icons (كلها في الجذر) -->
  <link rel="icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <title>Al Ajamy Food – Cars Tracker</title>

  <style>
    :root{
      --bg:#0f1213; --bg2:#0a0d0e;
      --card:#141b1d; --text:#eaf2f2; --muted:#b3c0bf;

      --teal:#4ea58f; --orange:#f48a22;
      --red:#ff3b4e; --yellow:#ffcc00; --amber:#ff8a24; --green:#2dd36f;

      --shadow:0 18px 50px rgba(0,0,0,.45);
      --r:22px; --r2:16px;

      --fs-1: clamp(13px, 1.6vw, 15px);
      --fs-2: clamp(16px, 2.2vw, 18px);
      --fs-3: clamp(18px, 2.8vw, 22px);
      --fsDays: clamp(26px, 4.2vw, 42px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic","Noto Sans Arabic", sans-serif;
      background:
        radial-gradient(1000px 600px at 85% 0%, rgba(78,165,143,.18), transparent 60%),
        radial-gradient(900px 520px at 10% 10%, rgba(244,138,34,.14), transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{max-width:1250px;margin:0 auto;padding:18px 14px 40px;}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border-radius:var(--r);
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      position:sticky;top:10px;z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0;flex:1;}
    .logo{
      width:56px;height:56px;border-radius:18px;overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      flex:0 0 auto;display:grid;place-items:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .title{min-width:0}
    .title h1{
      margin:0;font-size:var(--fs-3);font-weight:1000;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .subtitle{margin-top:3px;color:var(--muted);font-size:var(--fs-1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .pill{
      flex:0 0 auto;padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--muted);font-weight:900;font-size:var(--fs-1);
      white-space:nowrap;
    }
    @media (max-width: 720px){
      .topbar{position:static}
      .logo{width:52px;height:52px;border-radius:16px}
    }

    .sectionBg{
      margin-top:14px;padding:14px;border-radius:var(--r);
      border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.03);
    }

    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;}
    @media (max-width: 1100px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width: 720px){ .grid{grid-template-columns:1fr;} }

    .card{
      border-radius:var(--r);
      border:2px solid rgba(255,255,255,.22);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08));
      box-shadow:var(--shadow);
      overflow:hidden;position:relative;
    }
    .card::before{
      content:"";position:absolute;inset:10px;
      border-radius:calc(var(--r) - 10px);
      border:1px solid rgba(255,255,255,.08);
      pointer-events:none;
    }
    .cardInner{padding:14px;}

    .plateRow{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:10px;margin-bottom:10px;flex-wrap:wrap;
    }

    /* Plate (TR) */
    .plate{
      display:flex;align-items:stretch;border-radius:14px;overflow:hidden;
      border:2px solid rgba(0,0,0,.25);
      background:#f7f7f7;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      min-width:230px;max-width:360px;flex:0 0 auto;
    }
    .plate .tr{
      background:#0b3d91;color:#fff;font-weight:1000;
      padding:10px 14px;min-width:64px;
      display:flex;align-items:center;justify-content:center;
      letter-spacing:.9px;
    }
    .plate .num{
      flex:1;background:#fff;color:#111;font-weight:1000;
      padding:10px 14px;display:flex;align-items:center;justify-content:center;
      letter-spacing:2px;font-size:18px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .meta{
      flex:1;min-width:240px;border-radius:var(--r2);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      padding:10px 12px;
    }
    .metaTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .vehicleName{
      font-size:var(--fs-2);font-weight:1000;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:100%;
    }
    .branchTag{
      font-size:var(--fs-1);font-weight:900;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(78,165,143,.28);
      background:rgba(78,165,143,.10);
      white-space:nowrap;
    }
    .metaLine{margin-top:8px;font-size:var(--fs-1);color:var(--muted);display:flex;gap:12px;flex-wrap:wrap;}
    .metaLine b{color:var(--text);font-weight:1000;}

    .blocks{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width: 720px){
      .blocks{grid-template-columns:1fr;}
      .plate{min-width:210px;width:100%;max-width:100%;}
    }

    .block{
      border-radius:var(--r2);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      padding:12px;
      overflow:hidden;
    }
    .blockTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .blockTitle{font-size:var(--fs-3);font-weight:1000;letter-spacing:.2px;}

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      font-weight:1000;font-size:var(--fs-1);white-space:nowrap;
    }
    .badge svg{width:18px;height:18px;flex:0 0 auto;}
    .badge.urgent{border-color:rgba(255,59,78,.35);}
    .badge.alert{border-color:rgba(255,204,0,.35);}
    .badge.follow{border-color:rgba(244,138,34,.35);}
    .badge.safe{border-color:rgba(45,211,111,.35);}
    .badge.long{border-color:rgba(78,165,143,.35);}
    .badge.expired{border-color:rgba(255,59,78,.45);background:rgba(255,59,78,.08);}
    .badge.missing{border-color:rgba(255,255,255,.22);background:rgba(255,255,255,.06);color:rgba(234,242,242,.86);}

    .days{
      margin-top:10px;
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .daysNum{font-size:var(--fsDays);font-weight:1000;line-height:1;letter-spacing:.3px;}
    .daysTxt{font-size:var(--fs-3);font-weight:1000;color:rgba(234,242,242,.92);white-space:nowrap;}
    .daysMissing{
      margin-top:10px;
      font-size:var(--fs-2);
      font-weight:1000;
      color:rgba(234,242,242,.82);
    }

    .bar{
      margin-top:10px;height:12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar>span{display:block;height:100%;width:40%;border-radius:999px;background:linear-gradient(90deg, rgba(78,165,143,.95), rgba(45,211,111,.95));}
    .bar.urgent>span,.bar.expired>span{background:linear-gradient(90deg, rgba(255,59,78,.95), rgba(255,59,78,.72));}
    .bar.alert>span{background:linear-gradient(90deg, rgba(255,204,0,.95), rgba(244,138,34,.95));}
    .bar.follow>span{background:linear-gradient(90deg, rgba(244,138,34,.95), rgba(244,138,34,.70));}
    .bar.missing>span{width:28%;background:linear-gradient(90deg, rgba(255,255,255,.32), rgba(255,255,255,.12));}

    .empty{
      padding:18px;border-radius:var(--r);
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:var(--muted);font-weight:900;text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <img src="/logo.png" alt="Al Ajamy Logo" onerror="this.style.display='none'">
        </div>
        <div class="title">
          <h1>Al Ajamy Food – Cars Tracker</h1>
          <div class="subtitle" id="subLine">آخر تحديث: —</div>
        </div>
      </div>
      <div class="pill" id="countPill">— سيارة</div>
    </div>

    <div class="sectionBg">
      <div class="grid" id="grid"></div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyQxBuejrMv-YuaY46xF08MWOmo14jwuVG8ytr3-zABxSw528NgyHvDKFICPXRvpeW8EQ/exec";
  const AUTO_REFRESH_MS = 60000;

  const grid = document.getElementById("grid");
  const subLine = document.getElementById("subLine");
  const countPill = document.getElementById("countPill");

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function normalizePlate(s){
    return String(s || "").trim().replace(/\s+/g, " ");
  }

  // Parser قوي: يدعم dd-mm-yyyy / dd/mm/yyyy / yyyy-mm-dd / yyyy/mm/dd / ISO DateTime
  function parseAnyDate(val){
    if(val == null) return null;

    // رقم (احتمال serial) – نتركه null لأن مصادرنا غالباً نص
    if(typeof val === "number"){
      // إذا احتجت دعم serial لاحقاً بنضيفه، حالياً ما بدنا نكسر.
      return null;
    }

    const s = String(val).trim();
    if(!s) return null;

    // ISO مثل 2026-10-08T00:00:00.000Z
    if(/^\d{4}-\d{2}-\d{2}T/.test(s)){
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    // yyyy-mm-dd أو yyyy/mm/dd
    if(/^\d{4}[-\/]\d{2}[-\/]\d{2}$/.test(s)){
      const parts = s.split(/[-\/]/);
      const y = Number(parts[0]), m = Number(parts[1]), d = Number(parts[2]);
      const dt = new Date(y, m-1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    // dd-mm-yyyy أو dd/mm/yyyy
    if(/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(s)){
      const parts = s.split(/[-\/]/);
      const d = Number(parts[0]), m = Number(parts[1]), y = Number(parts[2]);
      const dt = new Date(y, m-1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    // محاولة أخيرة
    const fallback = new Date(s);
    return isNaN(fallback.getTime()) ? null : fallback;
  }

  function daysRemaining(dateVal){
    const dt = parseAnyDate(dateVal);
    if(!dt) return null;
    const today = new Date(); today.setHours(0,0,0,0);
    const x = new Date(dt); x.setHours(0,0,0,0);
    return Math.round((x - today) / 86400000);
  }

  function statusForDays(d){
    if(d === null) return { type:"missing", label:"غير محدد" };
    if(d < 0)      return { type:"expired", label:"منتهية" };
    if(d <= 15)    return { type:"urgent",  label:"عاجل" };
    if(d <= 30)    return { type:"alert",   label:"تنبيه" };
    if(d <= 60)    return { type:"follow",  label:"متابعة" };
    if(d <= 120)   return { type:"safe",    label:"المدة آمنة" };
    return          { type:"long",    label:"مدة طويلة" };
  }

  function barWidth(d){
    if(d === null) return 28;
    if(d < 0) return 100;
    const capped = Math.min(Math.max(d, 0), 180);
    const w = 100 - Math.round((capped/180)*85);
    return Math.max(12, Math.min(100, w));
  }

  function svgAlert(){
    return `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#ffcc00" d="M12 3 1 21h22L12 3z"></path>
        <path fill="#111" d="M11 9h2v6h-2z"></path>
        <circle cx="12" cy="18" r="1.2" fill="#111"></circle>
      </svg>`;
  }
  function svgUrgent(){
    return `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="10" fill="#ff3b4e"></circle>
        <path fill="#fff" d="M11 7h2v8h-2z"></path>
        <circle cx="12" cy="17.6" r="1.2" fill="#fff"></circle>
      </svg>`;
  }
  function svgExpired(){
    return `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#ff3b4e" d="M7.2 2h9.6L22 7.2v9.6L16.8 22H7.2L2 16.8V7.2L7.2 2z"></path>
        <path fill="#fff" d="M11 7h2v8h-2z"></path>
        <circle cx="12" cy="17.6" r="1.2" fill="#fff"></circle>
      </svg>`;
  }
  function svgDot(color){
    return `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="${color}"></circle></svg>`;
  }

  function badgeIcon(type){
    if(type === "alert") return svgAlert();
    if(type === "urgent") return svgUrgent();
    if(type === "expired") return svgExpired();
    if(type === "follow") return svgDot("#ff8a24");
    if(type === "missing") return svgDot("rgba(255,255,255,.35)");
    return svgDot("#2dd36f");
  }

  function blockHTML(title, days){
    const st = statusForDays(days);
    const icon = badgeIcon(st.type);
    const w = barWidth(days);

    // منتهية: نعرض 0 يوم متبقي (بدون أرقام سالبة)
    const shownDays = (days === null) ? null : (days < 0 ? 0 : days);

    // إذا غير محدد: لا نعرض "يوم متبقي" نهائياً
    const daysPart = (shownDays === null)
      ? `<div class="daysMissing">غير محدد</div>`
      : `
        <div class="days">
          <div class="daysNum">${shownDays}</div>
          <div class="daysTxt">يوم متبقي</div>
        </div>
      `;

    const barClass = (st.type === "missing") ? "missing" : st.type;

    return `
      <div class="block">
        <div class="blockTop">
          <div class="blockTitle">${title}</div>
          <div class="badge ${st.type}">${icon}<span>${st.label}</span></div>
        </div>
        ${daysPart}
        <div class="bar ${barClass}"><span style="width:${w}%"></span></div>
      </div>
    `;
  }

  function cardHTML(row){
    const plate = normalizePlate(row.plate);
    const vehicle = row.vehicle || "—";
    const driver = row.driver || "—";
    const phone = row.driver_phone || "—";
    const branch = row.branch || "—";

    const inspDays = daysRemaining(row.inspection_date);
    const sigDays  = daysRemaining(row.sigorta_date);

    return `
      <div class="card">
        <div class="cardInner">
          <div class="plateRow">
            <div class="meta">
              <div class="metaTop">
                <div class="vehicleName" title="${escapeHtml(vehicle)}">${escapeHtml(vehicle)}</div>
                <div class="branchTag">${escapeHtml(branch)}</div>
              </div>
              <div class="metaLine">
                <span>السائق: <b>${escapeHtml(driver)}</b></span>
                <span>هاتف: <b dir="ltr">${escapeHtml(phone)}</b></span>
              </div>
            </div>

            <div class="plate" title="لوحة تركية">
              <div class="tr">TR</div>
              <div class="num" dir="ltr">${escapeHtml(plate || "—")}</div>
            </div>
          </div>

          <div class="blocks">
            ${blockHTML("المعاينة", inspDays)}
            ${blockHTML("السيكورتا", sigDays)}
          </div>
        </div>
      </div>
    `;
  }

  function jsonpLoad(){
    return new Promise((resolve, reject)=>{
      const cb = "__cbCars_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      const src = API_URL + (API_URL.includes("?") ? "&" : "?") + "callback=" + cb + "&ts=" + Date.now();

      const timeout = setTimeout(()=>{
        cleanup();
        reject(new Error("timeout"));
      }, 12000);

      window[cb] = (data)=>{
        cleanup();
        resolve(data);
      };

      function cleanup(){
        clearTimeout(timeout);
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        if(s && s.parentNode) s.parentNode.removeChild(s);
      }

      s.src = src;
      s.onerror = ()=>{
        cleanup();
        reject(new Error("jsonp error"));
      };

      document.head.appendChild(s);
    });
  }

  function minDue(d1, d2){
    const arr = [d1, d2].filter(v => v !== null);
    if(arr.length === 0) return 999999;
    if(arr.some(v => v < 0)) return -999999;
    return Math.min(...arr);
  }

  async function load(){
    try{
      const res = await jsonpLoad();
      if(!res || res.ok !== true) throw new Error(res?.error || "Bad response");

      const data = Array.isArray(res.data) ? res.data : [];
      countPill.textContent = data.length + " سيارة";
      subLine.textContent = "آخر تحديث: " + new Date().toLocaleString("en-GB");

      if(data.length === 0){
        grid.innerHTML = `<div class="empty">لا توجد بيانات للعرض حالياً</div>`;
        return;
      }

      const sorted = [...data].sort((a,b)=>{
        const a1 = daysRemaining(a.inspection_date);
        const a2 = daysRemaining(a.sigorta_date);
        const b1 = daysRemaining(b.inspection_date);
        const b2 = daysRemaining(b.sigorta_date);
        return minDue(a1,a2) - minDue(b1,b2);
      });

      grid.innerHTML = sorted.map(cardHTML).join("");

    }catch(err){
      grid.innerHTML = `<div class="empty">تعذر تحميل البيانات. تأكد من رابط Apps Script.</div>`;
      countPill.textContent = "— سيارة";
      subLine.textContent = "آخر تحديث: —";
    }
  }

  load();
  setInterval(load, AUTO_REFRESH_MS);
</script>
</body>
</html>
