<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0f1d1a" />
  <meta name="description" content="Al Ajamy Food – Cars Tracker" />

  <!-- PWA / Icons (كما اتفقنا: كلها في الجذر) -->
  <link rel="icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <title>Al Ajamy Food – Cars Tracker</title>

  <style>
    :root{
      --bg:#0f1213;
      --bg2:#0a0d0e;
      --card:#141b1d;
      --card2:#0f1415;
      --text:#eaf2f2;
      --muted:#b3c0bf;

      /* Brand-ish (قريب من اللوغو) */
      --teal:#4ea58f;
      --teal2:#2a7b69;
      --orange:#f48a22;

      /* Status */
      --red:#ff3b4e;
      --yellow:#ffcc00;
      --amber:#ff8a24;
      --green:#2dd36f;

      --border:rgba(255,255,255,.18);
      --borderStrong:rgba(255,255,255,.28);
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --r:22px;
      --r2:16px;

      --fs-1: clamp(13px, 1.6vw, 15px);
      --fs-2: clamp(16px, 2.2vw, 18px);
      --fs-3: clamp(18px, 2.8vw, 22px);
      --fsDays: clamp(26px, 4.2vw, 42px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic","Noto Sans Arabic", sans-serif;
      background:
        radial-gradient(1000px 600px at 85% 0%, rgba(78,165,143,.18), transparent 60%),
        radial-gradient(900px 520px at 10% 10%, rgba(244,138,34,.14), transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1250px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
      flex:1;
    }

    .logo{
      width: 56px;
      height: 56px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      flex:0 0 auto;
      display:grid;
      place-items:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}

    .title{
      min-width:0;
    }
    .title h1{
      margin:0;
      font-size: var(--fs-3);
      font-weight: 1000;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      margin-top: 3px;
      color: var(--muted);
      font-size: var(--fs-1);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .pill{
      flex:0 0 auto;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-weight: 900;
      font-size: var(--fs-1);
      white-space: nowrap;
    }

    @media (max-width: 720px){
      .topbar{position:static}
      .logo{width:52px;height:52px;border-radius:16px}
    }

    /* Background section */
    .sectionBg{
      margin-top: 14px;
      padding: 14px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
    }

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 14px;
    }
    @media (max-width: 1100px){
      .grid{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
    @media (max-width: 720px){
      .grid{grid-template-columns: 1fr}
    }

    /* Card */
    .card{
      border-radius: var(--r);
      border: 2px solid rgba(255,255,255,.22); /* أوضح شوي */
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08));
      box-shadow: var(--shadow);
      overflow:hidden;
      position: relative;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: calc(var(--r) - 10px);
      border: 1px solid rgba(255,255,255,.08);
      pointer-events:none;
    }

    .cardInner{ padding: 14px; }

    /* Plate (Turkey style clean) */
    .plateRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .plate{
      display:flex;
      align-items: stretch;
      border-radius: 14px;
      overflow:hidden;
      border: 2px solid rgba(0,0,0,.25);
      background:#f7f7f7;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      min-width: 230px;
      max-width: 360px;
      flex: 0 0 auto;
    }
    .plate .tr{
      background:#0b3d91;
      color:#fff;
      font-weight: 1000;
      padding: 10px 14px;
      min-width: 64px;
      display:flex;
      align-items:center;
      justify-content:center;
      letter-spacing:.9px;
    }
    .plate .num{
      flex:1;
      background:#fff;
      color:#111;
      font-weight: 1000;
      padding: 10px 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      letter-spacing: 2px;
      font-size: 18px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* Car meta */
    .meta{
      flex: 1;
      min-width: 240px;
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding: 10px 12px;
    }
    .metaTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
    }
    .vehicleName{
      font-size: var(--fs-2);
      font-weight: 1000;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .branchTag{
      font-size: var(--fs-1);
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(78,165,143,.28);
      background: rgba(78,165,143,.10);
      white-space: nowrap;
    }
    .metaLine{
      margin-top: 8px;
      font-size: var(--fs-1);
      color: var(--muted);
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .metaLine b{ color: var(--text); font-weight: 1000; }

    /* Two blocks */
    .blocks{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 720px){
      .blocks{ grid-template-columns: 1fr; }
      .plate{ min-width: 210px; width: 100%; max-width: 100%; }
    }

    .block{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding: 12px;
      overflow:hidden;
    }

    .blockTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .blockTitle{
      font-size: var(--fs-3);
      font-weight: 1000;
      letter-spacing:.2px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      font-weight: 1000;
      font-size: var(--fs-1);
      white-space: nowrap;
    }
    .badge svg{ width:18px; height:18px; flex:0 0 auto; }

    .badge.urgent{ border-color: rgba(255,59,78,.35); }
    .badge.alert { border-color: rgba(255,204,0,.35); }
    .badge.follow{ border-color: rgba(244,138,34,.35); }
    .badge.safe  { border-color: rgba(45,211,111,.35); }
    .badge.long  { border-color: rgba(78,165,143,.35); }
    .badge.expired{ border-color: rgba(255,59,78,.45); background: rgba(255,59,78,.08); }

    .days{
      margin-top: 10px;
      display:flex;
      align-items: baseline;
      gap: 10px;
      flex-wrap: wrap;
    }
    .daysNum{
      font-size: var(--fsDays);
      font-weight: 1000;
      line-height: 1;
      letter-spacing:.3px;
    }
    .daysTxt{
      font-size: var(--fs-3);
      font-weight: 1000;
      color: rgba(234,242,242,.92);
      white-space: nowrap;
    }

    .bar{
      margin-top: 10px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > span{
      display:block;
      height:100%;
      width: 40%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(78,165,143,.95), rgba(45,211,111,.95));
      box-shadow: 0 0 18px rgba(45,211,111,.12);
    }
    .bar.urgent > span, .bar.expired > span{
      background: linear-gradient(90deg, rgba(255,59,78,.95), rgba(255,59,78,.72));
    }
    .bar.alert > span{
      background: linear-gradient(90deg, rgba(255,204,0,.95), rgba(244,138,34,.95));
    }
    .bar.follow > span{
      background: linear-gradient(90deg, rgba(244,138,34,.95), rgba(244,138,34,.70));
    }

    .empty{
      padding: 18px;
      border-radius: var(--r);
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-weight: 900;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <img src="/logo.png" alt="Al Ajamy Logo" onerror="this.style.display='none'">
        </div>
        <div class="title">
          <h1>Al Ajamy Food – Cars Tracker</h1>
          <div class="subtitle" id="subLine">آخر تحديث: —</div>
        </div>
      </div>
      <div class="pill" id="countPill">— سيارة</div>
    </div>

    <div class="sectionBg">
      <div class="grid" id="grid"></div>
    </div>
  </div>

<script>
  /* رابط Apps Script Web App */
  const API_URL = "https://script.google.com/macros/s/AKfycbyQxBuejrMv-YuaY46xF08MWOmo14jwuVG8ytr3-zABxSw528NgyHvDKFICPXRvpeW8EQ/exec";
  const AUTO_REFRESH_MS = 60000; // تحديث تلقائي كل دقيقة

  const grid = document.getElementById("grid");
  const subLine = document.getElementById("subLine");
  const countPill = document.getElementById("countPill");

  function pad2(n){ return String(n).padStart(2,"0"); }

  /* Parse dd-mm-yyyy (والأفضل لشيتك) */
  function parseDMY(s){
    if(!s) return null;
    const str = String(s).trim();
    if(!str) return null;

    // dd-mm-yyyy or dd/mm/yyyy
    const parts = str.split(/[-\/]/);
    if(parts.length !== 3) return null;
    const d = Number(parts[0]), m = Number(parts[1]), y = Number(parts[2]);
    if(!y || !m || !d) return null;

    const dt = new Date(y, m-1, d);
    if(isNaN(dt.getTime())) return null;
    return dt;
  }

  function daysRemaining(dateStr){
    const dt = parseDMY(dateStr);
    if(!dt) return null;
    const today = new Date();
    today.setHours(0,0,0,0);
    dt.setHours(0,0,0,0);
    return Math.round((dt - today) / 86400000);
  }

  function normalizePlate(s){
    return String(s || "").trim().replace(/\s+/g, " ");
  }

  function statusForDays(d){
    if(d === null) return { key:"long", label:"مدة طويلة", type:"long" };
    if(d < 0)      return { key:"expired", label:"منتهية", type:"expired" };
    if(d <= 15)    return { key:"urgent", label:"عاجل", type:"urgent" };
    if(d <= 30)    return { key:"alert", label:"تنبيه", type:"alert" };
    if(d <= 60)    return { key:"follow", label:"متابعة", type:"follow" };
    if(d <= 120)   return { key:"safe", label:"المدة آمنة", type:"safe" };
    return          { key:"long", label:"مدة طويلة", type:"long" };
  }

  function barWidth(d){
    if(d === null) return 65;
    if(d < 0) return 100;
    const capped = Math.min(Math.max(d, 0), 180);
    // closer due => larger bar
    const w = 100 - Math.round((capped/180)*85); // 100..15
    return Math.max(12, Math.min(100, w));
  }

  /* Icons (colored) */
  function svgAlert(){
    return `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#ffcc00" d="M12 3 1 21h22L12 3z"></path>
        <path fill="#111" d="M11 9h2v6h-2z"></path>
        <circle cx="12" cy="18" r="1.2" fill="#111"></circle>
      </svg>`;
  }
  function svgUrgent(){
    return `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="10" fill="#ff3b4e"></circle>
        <path fill="#fff" d="M11 7h2v8h-2z"></path>
        <circle cx="12" cy="17.6" r="1.2" fill="#fff"></circle>
      </svg>`;
  }
  function svgExpired(){
    return `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#ff3b4e" d="M7.2 2h9.6L22 7.2v9.6L16.8 22H7.2L2 16.8V7.2L7.2 2z"></path>
        <path fill="#fff" d="M11 7h2v8h-2z"></path>
        <circle cx="12" cy="17.6" r="1.2" fill="#fff"></circle>
      </svg>`;
  }
  function svgFollow(){
    return `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="#ff8a24"></circle></svg>`;
  }
  function svgGreen(){
    return `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="#2dd36f"></circle></svg>`;
  }

  function badgeIcon(type){
    if(type === "alert") return svgAlert();
    if(type === "urgent") return svgUrgent();
    if(type === "expired") return svgExpired();
    if(type === "follow") return svgFollow();
    return svgGreen(); // safe/long
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function blockHTML(title, days){
    const st = statusForDays(days);
    const icon = badgeIcon(st.type);
    const shownDays = (days === null) ? "—" : String(days);
    const w = barWidth(days);

    return `
      <div class="block">
        <div class="blockTop">
          <div class="blockTitle">${title}</div>
          <div class="badge ${st.type}">${icon}<span>${st.label}</span></div>
        </div>

        <div class="days">
          <div class="daysNum">${shownDays}</div>
          <div class="daysTxt">يوم متبقي</div>
        </div>

        <div class="bar ${st.type}"><span style="width:${w}%"></span></div>
      </div>
    `;
  }

  function cardHTML(row){
    const plate = normalizePlate(row.plate);
    const vehicle = row.vehicle || "—";
    const driver = row.driver || "—";
    const phone = row.driver_phone || "—";
    const branch = row.branch || "—";

    const inspDays = daysRemaining(row.inspection_date);
    const sigDays  = daysRemaining(row.sigorta_date);

    return `
      <div class="card">
        <div class="cardInner">
          <div class="plateRow">
            <div class="meta">
              <div class="metaTop">
                <div class="vehicleName" title="${escapeHtml(vehicle)}">${escapeHtml(vehicle)}</div>
                <div class="branchTag">${escapeHtml(branch)}</div>
              </div>
              <div class="metaLine">
                <span>السائق: <b>${escapeHtml(driver)}</b></span>
                <span>هاتف: <b dir="ltr">${escapeHtml(phone)}</b></span>
              </div>
            </div>

            <div class="plate" title="لوحة تركية">
              <div class="tr">TR</div>
              <div class="num" dir="ltr">${escapeHtml(plate || "—")}</div>
            </div>
          </div>

          <div class="blocks">
            ${blockHTML("المعاينة", inspDays)}
            ${blockHTML("السيكورتا", sigDays)}
          </div>
        </div>
      </div>
    `;
  }

  /* JSONP loader (doGet must support ?callback= ) */
  function jsonpLoad(){
    return new Promise((resolve, reject)=>{
      const cb = "__cbCars_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      const src = API_URL + (API_URL.includes("?") ? "&" : "?") + "callback=" + cb + "&ts=" + Date.now();

      const timeout = setTimeout(()=>{
        cleanup();
        reject(new Error("timeout"));
      }, 12000);

      window[cb] = (data)=>{
        cleanup();
        resolve(data);
      };

      function cleanup(){
        clearTimeout(timeout);
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        if(s && s.parentNode) s.parentNode.removeChild(s);
      }

      s.src = src;
      s.onerror = ()=>{
        cleanup();
        reject(new Error("jsonp error"));
      };

      document.head.appendChild(s);
    });
  }

  async function load(){
    try{
      const res = await jsonpLoad();
      if(!res || res.ok !== true){
        throw new Error(res?.error || "Bad response");
      }

      const data = Array.isArray(res.data) ? res.data : [];
      countPill.textContent = data.length + " سيارة";
      subLine.textContent = "آخر تحديث: " + new Date().toLocaleString("en-GB");

      if(data.length === 0){
        grid.innerHTML = `<div class="empty">لا توجد بيانات للعرض حالياً</div>`;
        return;
      }

      // ترتيب حسب الأقرب استحقاق (أصغر عدد أيام من المعاينة/السيكورتا)
      const sorted = [...data].sort((a,b)=>{
        const a1 = daysRemaining(a.inspection_date);
        const a2 = daysRemaining(a.sigorta_date);
        const b1 = daysRemaining(b.inspection_date);
        const b2 = daysRemaining(b.sigorta_date);

        const minA = minDue(a1, a2);
        const minB = minDue(b1, b2);
        return minA - minB;
      });

      grid.innerHTML = sorted.map(cardHTML).join("");

    }catch(err){
      grid.innerHTML = `<div class="empty">تعذر تحميل البيانات. تأكد من رابط Apps Script.</div>`;
      countPill.textContent = "— سيارة";
      subLine.textContent = "آخر تحديث: —";
    }
  }

  function minDue(d1, d2){
    const arr = [d1, d2].filter(v => v !== null);
    if(arr.length === 0) return 999999;
    if(arr.some(v => v < 0)) return -999999; // المنتهية أولاً
    return Math.min(...arr);
  }

  // تشغيل
  load();
  setInterval(load, AUTO_REFRESH_MS);
</script>
</body>
</html>
