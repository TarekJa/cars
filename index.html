<script>
  /* ضع رابط الـ Apps Script الخاص بك هنا */
  const API_URL = "https://script.google.com/macros/s/AKfycbyQxBuejrMv-YuaY46xF08MWOmo14jwuVG8ytr3-zABxSw528NgyHvDKFICPXRvpeW8EQ/exec";
  const AUTO_REFRESH_MS = 60000;

  // مقياس الشريط (365 يوم)
  const MAX_DAYS = 365;

  const grid = document.getElementById("grid");
  const subLine = document.getElementById("subLine");
  const countPill = document.getElementById("countPill");

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function normalizePlate(s){
    return String(s || "").trim().replace(/\s+/g, " ");
  }

  /* Parser يدعم:
     dd-mm-yyyy / dd/mm/yyyy
     yyyy-mm-dd / yyyy/mm/dd
     ISO datetime
  */
  function parseAnyDate(val){
    if(val == null) return null;

    const s = String(val).trim();
    if(!s) return null;

    // ISO datetime
    if(/^\d{4}-\d{2}-\d{2}T/.test(s)){
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    // yyyy-mm-dd
    if(/^\d{4}[-\/]\d{2}[-\/]\d{2}$/.test(s)){
      const [y,m,d] = s.split(/[-\/]/).map(Number);
      const dt = new Date(y, m-1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    // dd-mm-yyyy
    if(/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(s)){
      const [d,m,y] = s.split(/[-\/]/).map(Number);
      const dt = new Date(y, m-1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    // fallback
    const fallback = new Date(s);
    return isNaN(fallback.getTime()) ? null : fallback;
  }

  /* ✅ حساب أيام متبقية “دقيق”:
     - نستخدم UTC Date فقط من (سنة/شهر/يوم) لتجنب فروقات التوقيت وDST
     - اليوم محسوب كنفس اليوم (00:00) UTC
  */
  function daysRemaining(dateVal){
    const dt = parseAnyDate(dateVal);
    if(!dt) return null;

    const targetUTC = Date.UTC(dt.getFullYear(), dt.getMonth(), dt.getDate());

    const now = new Date();
    const todayUTC  = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate());

    return Math.floor((targetUTC - todayUTC) / 86400000);
  }

  /* حالة حسب الأيام */
  function statusForDays(d){
    if(d === null) return { type:"missing", label:"غير محدد" };
    if(d < 0)      return { type:"expired", label:"منتهية" };
    if(d <= 15)    return { type:"urgent",  label:"عاجل" };
    if(d <= 30)    return { type:"alert",   label:"تنبيه" };
    if(d <= 60)    return { type:"follow",  label:"متابعة" };
    if(d <= 120)   return { type:"safe",    label:"المدة آمنة" };
    return          { type:"long",    label:"مدة طويلة" };
  }

  /* ✅ طول الشريط: من 0 إلى 365 يوم
     كل ما نقصت الأيام = الشريط يقصر
  */
  function barWidth(d){
    if(d === null) return 20;           // غير محدد = شريط صغير
    if(d <= 0) return 0;                // منتهية أو اليوم = صفر
    const clamped = Math.min(d, MAX_DAYS);
    return Math.round((clamped / MAX_DAYS) * 100);
  }

  /* تدرّج لون حسب الأيام المتبقية:
     365: أخضر
     120: أخضر فاتح
     60 : برتقالي
     30 : أصفر
     15 : أحمر
     0  : أحمر
  */
  const COLOR_STOPS = [
    { d: 0,   c: [255, 59, 78] },   // red
    { d: 15,  c: [255, 59, 78] },   // red
    { d: 30,  c: [255, 204, 0] },   // yellow
    { d: 60,  c: [255, 138, 36] },  // orange
    { d: 120, c: [120, 255, 170] }, // light green
    { d: 365, c: [45, 211, 111] },  // green
  ];

  function lerp(a,b,t){ return a + (b-a)*t; }

  function colorForDays(d){
    if(d === null) return "rgba(255,255,255,.25)";
    if(d <= 0) return "rgb(255,59,78)";

    const x = Math.max(0, Math.min(d, MAX_DAYS));

    // ابحث عن interval
    for(let i=0;i<COLOR_STOPS.length-1;i++){
      const s0 = COLOR_STOPS[i];
      const s1 = COLOR_STOPS[i+1];
      if(x >= s0.d && x <= s1.d){
        const t = (x - s0.d) / (s1.d - s0.d || 1);
        const r = Math.round(lerp(s0.c[0], s1.c[0], t));
        const g = Math.round(lerp(s0.c[1], s1.c[1], t));
        const b = Math.round(lerp(s0.c[2], s1.c[2], t));
        return `rgb(${r},${g},${b})`;
      }
    }
    return "rgb(45,211,111)";
  }

  function lightenRgb(rgb, amt=0.18){
    // rgb(r,g,b)
    const m = rgb.match(/rgb\((\d+),(\d+),(\d+)\)/);
    if(!m) return rgb;
    const r = +m[1], g = +m[2], b = +m[3];
    const nr = Math.round(lerp(r, 255, amt));
    const ng = Math.round(lerp(g, 255, amt));
    const nb = Math.round(lerp(b, 255, amt));
    return `rgb(${nr},${ng},${nb})`;
  }

  /* أيقونات الحالات (مثل ما طلبت سابقاً) */
  function svgAlert(){
    return `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#ffcc00" d="M12 3 1 21h22L12 3z"></path>
        <path fill="#111" d="M11 9h2v6h-2z"></path>
        <circle cx="12" cy="18" r="1.2" fill="#111"></circle>
      </svg>`;
  }
  function svgUrgent(){
    return `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="10" fill="#ff3b4e"></circle>
        <path fill="#fff" d="M11 7h2v8h-2z"></path>
        <circle cx="12" cy="17.6" r="1.2" fill="#fff"></circle>
      </svg>`;
  }
  function svgExpired(){
    return `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#ff3b4e" d="M7.2 2h9.6L22 7.2v9.6L16.8 22H7.2L2 16.8V7.2L7.2 2z"></path>
        <path fill="#fff" d="M11 7h2v8h-2z"></path>
        <circle cx="12" cy="17.6" r="1.2" fill="#fff"></circle>
      </svg>`;
  }
  function svgDot(color){
    return `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="${color}"></circle></svg>`;
  }
  function badgeIcon(type){
    if(type === "alert") return svgAlert();
    if(type === "urgent") return svgUrgent();
    if(type === "expired") return svgExpired();
    if(type === "follow") return svgDot("#ff8a24");
    if(type === "missing") return svgDot("rgba(255,255,255,.35)");
    return svgDot("#2dd36f");
  }

  function blockHTML(title, days){
    const st = statusForDays(days);
    const icon = badgeIcon(st.type);

    // ✅ لو منتهية/سالب: نعرض 0 لكن نحسب اللون كشريط أحمر وصفر طول
    const shownDays = (days === null) ? null : (days < 0 ? 0 : days);

    const w = barWidth(days);
    const baseColor = colorForDays(days);
    const endColor = lightenRgb(baseColor, 0.15);

    const daysPart = (shownDays === null)
      ? `<div class="daysMissing">غير محدد</div>`
      : `<div class="days">
           <div class="daysNum">${shownDays}</div>
           <div class="daysTxt">يوم متبقي</div>
         </div>`;

    return `
      <div class="block">
        <div class="blockTop">
          <div class="blockTitle">${title}</div>
          <div class="badge ${st.type}">${icon}<span>${st.label}</span></div>
        </div>

        ${daysPart}

        <div class="bar ${st.type}">
          <span style="
            width:${w}%;
            background: linear-gradient(90deg, ${baseColor}, ${endColor});
          "></span>
        </div>
      </div>
    `;
  }

  function cardHTML(row){
    const plate = normalizePlate(row.plate);
    const vehicle = row.vehicle || "—";
    const driver = row.driver || "—";
    const phone = row.driver_phone || "—";
    const branch = row.branch || "—";

    const inspDays = daysRemaining(row.inspection_date);
    const sigDays  = daysRemaining(row.sigorta_date);

    return `
      <div class="card">
        <div class="cardInner">
          <div class="topRow">
            <div class="meta">
              <div class="metaTop">
                <div class="vehicleName" title="${escapeHtml(vehicle)}">${escapeHtml(vehicle)}</div>
                <div class="branchTag">${escapeHtml(branch)}</div>
              </div>
              <div class="metaLine">
                <span>السائق: <b>${escapeHtml(driver)}</b></span>
                <span>هاتف: <b dir="ltr">${escapeHtml(phone)}</b></span>
              </div>
            </div>

            <div class="plate" title="لوحة تركية">
              <div class="tr">TR</div>
              <div class="num" dir="ltr">${escapeHtml(plate || "—")}</div>
            </div>
          </div>

          <div class="blocks">
            ${blockHTML("المعاينة", inspDays)}
            ${blockHTML("السيكورتا", sigDays)}
          </div>
        </div>
      </div>
    `;
  }

  /* JSONP load */
  function jsonpLoad(){
    return new Promise((resolve, reject)=>{
      const cb = "__cbCars_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      const s = document.createElement("script");
      const src = API_URL + (API_URL.includes("?") ? "&" : "?") + "callback=" + cb + "&ts=" + Date.now();

      const timeout = setTimeout(()=>{
        cleanup();
        reject(new Error("timeout"));
      }, 12000);

      window[cb] = (data)=>{
        cleanup();
        resolve(data);
      };

      function cleanup(){
        clearTimeout(timeout);
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        if(s && s.parentNode) s.parentNode.removeChild(s);
      }

      s.src = src;
      s.onerror = ()=>{
        cleanup();
        reject(new Error("jsonp error"));
      };

      document.head.appendChild(s);
    });
  }

  function minDue(d1, d2){
    const arr = [d1, d2].filter(v => v !== null);
    if(arr.length === 0) return 999999;
    if(arr.some(v => v < 0)) return -999999;
    return Math.min(...arr);
  }

  async function load(){
    try{
      const res = await jsonpLoad();
      if(!res || res.ok !== true) throw new Error(res?.error || "Bad response");

      const data = Array.isArray(res.data) ? res.data : [];
      countPill.textContent = data.length + " سيارة";
      subLine.textContent = "آخر تحديث: " + new Date().toLocaleString("en-GB");

      if(data.length === 0){
        grid.innerHTML = `<div class="empty">لا توجد بيانات للعرض حالياً</div>`;
        return;
      }

      // ترتيب حسب الأقرب استحقاق
      const sorted = [...data].sort((a,b)=>{
        const a1 = daysRemaining(a.inspection_date);
        const a2 = daysRemaining(a.sigorta_date);
        const b1 = daysRemaining(b.inspection_date);
        const b2 = daysRemaining(b.sigorta_date);
        return minDue(a1,a2) - minDue(b1,b2);
      });

      grid.innerHTML = sorted.map(cardHTML).join("");

    }catch(err){
      grid.innerHTML = `<div class="empty">تعذر تحميل البيانات. تأكد من رابط Apps Script.</div>`;
      countPill.textContent = "— سيارة";
      subLine.textContent = "آخر تحديث: —";
    }
  }

  load();
  setInterval(load, AUTO_REFRESH_MS);
</script>
